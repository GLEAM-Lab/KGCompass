<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>补丁预览 - {{ instance_id }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    
    <style>
        .patch-container {
            background-color: #0d1117;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .patch-header {
            background-color: #21262d;
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
        }
        
        .patch-content {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.45;
            overflow-x: auto;
        }
        
        .patch-line {
            padding: 2px 16px 2px 10px;
            display: block;
            white-space: pre;
            border-left: 4px solid transparent;
        }
        
        .patch-line-added {
            background-color: rgba(46, 160, 67, 0.15);
            border-left-color: #2ea043;
            color: #aff5b4;
        }
        
        .patch-line-removed {
            background-color: rgba(248, 81, 73, 0.15);
            border-left-color: #f85149;
            color: #ffdcd7;
        }
        
        .patch-line-context {
            color: #c9d1d9;
        }
        
        .patch-line-hunk {
            background-color: rgba(56, 139, 253, 0.15);
            color: #79c0ff;
            font-weight: bold;
        }
        
        .line-number {
            color: #8b949e;
            user-select: none;
            text-align: right;
            width: 50px;
            display: inline-block;
            margin-right: 16px;
        }
        
        .stats-badge {
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .copy-button {
            position: relative;
        }
        
        .copy-button.copied::after {
            content: "已复制!";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #238636;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-project-diagram me-2"></i>
                KGCompass
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-arrow-left me-1"></i>
                    返回主页
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 补丁信息卡片 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-code me-2"></i>
                            补丁预览
                        </h5>
                        <small class="opacity-75">{{ instance_id }}</small>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-light btn-sm copy-button" onclick="copyPatchContent()">
                            <i class="fas fa-copy me-1"></i>
                            复制补丁
                        </button>
                        <a href="{{ download_url }}" class="btn btn-success btn-sm ms-2">
                            <i class="fas fa-download me-1"></i>
                            下载
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">仓库信息</h6>
                        <p class="mb-1"><strong>仓库:</strong> {{ repo_name }}</p>
                        <p class="mb-1"><strong>实例ID:</strong> {{ instance_id }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">修改统计</h6>
                        <div>
                            {% if stats %}
                            <span class="badge bg-success stats-badge me-2">
                                <i class="fas fa-plus"></i> +{{ stats.additions }} 行
                            </span>
                            <span class="badge bg-danger stats-badge me-2">
                                <i class="fas fa-minus"></i> -{{ stats.deletions }} 行
                            </span>
                            <span class="badge bg-info stats-badge">
                                <i class="fas fa-file"></i> {{ stats.files }} 文件
                            </span>
                            {% else %}
                            <span class="text-muted">统计信息不可用</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 补丁内容 -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0">
                    <i class="fas fa-code me-2"></i>
                    补丁内容
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="patch-container">
                    {% if patch_content %}
                    <div class="patch-content">
                        {% for line in patch_lines %}
                        <div class="patch-line {{ line.type }}">{{ line.content | e }}</div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
                        <h5>补丁内容不可用</h5>
                        <p class="text-muted">无法读取补丁文件内容</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 文件差异详情 -->
        {% if file_changes %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    修改的文件 ({{ file_changes | length }})
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for file in file_changes %}
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3">
                            <h6 class="mb-2">
                                <i class="fas fa-file-code text-primary me-1"></i>
                                {{ file.filename }}
                            </h6>
                            <div class="small text-muted">
                                <span class="badge bg-success me-1">+{{ file.additions }}</span>
                                <span class="badge bg-danger me-1">-{{ file.deletions }}</span>
                                <span class="text-muted">{{ file.changes }} 处修改</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <script>
        // 复制补丁内容到剪贴板
        async function copyPatchContent() {
            const copyButton = document.querySelector('.copy-button');
            
            try {
                // 获取补丁内容
                const patchLines = document.querySelectorAll('.patch-line');
                const patchContent = Array.from(patchLines)
                    .map(line => line.textContent)
                    .join('\n');
                
                await navigator.clipboard.writeText(patchContent);
                
                // 显示复制成功反馈
                copyButton.classList.add('copied');
                copyButton.innerHTML = '<i class="fas fa-check me-1"></i>已复制';
                
                setTimeout(() => {
                    copyButton.classList.remove('copied');
                    copyButton.innerHTML = '<i class="fas fa-copy me-1"></i>复制补丁';
                }, 2000);
                
            } catch (err) {
                console.error('复制失败:', err);
                copyButton.innerHTML = '<i class="fas fa-times me-1"></i>复制失败';
                copyButton.classList.add('btn-danger');
                
                setTimeout(() => {
                    copyButton.innerHTML = '<i class="fas fa-copy me-1"></i>复制补丁';
                    copyButton.classList.remove('btn-danger');
                }, 2000);
            }
        }
        
        // 初始化代码高亮
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html> 